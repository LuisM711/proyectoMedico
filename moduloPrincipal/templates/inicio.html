{% extends 'layouts/nav.html' %}
{% load static %}
{% block title %}Inicio{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/inicio.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<h1>Hola, {{ request.user }}</h1>
<div id="carouselExampleRide" class="carousel slide" data-bs-ride="carousel" data-bs-interval="2000">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img src="{% static 'images/carousel/carrusel1.png' %}" class="d-block w-100" alt="...">
        </div>
        <div class="carousel-item">
            <img src="{% static 'images/carousel/carrusel2.jpg' %}" class="d-block w-100" alt="...">
        </div>
        <div class="carousel-item">
            <img src="{% static 'images/carousel/carrusel3.jpg' %}" class="d-block w-100" alt="...">
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleRide" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleRide" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>
<div class="assistant-container position-fixed bottom-0 end-0 mb-3 me-3">
    <div class="card shadow-sm assistant-card" id="assistantCard" style="display: block; max-width: 300px;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span>Asistente virtual</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleAssistant()"></button>
        </div>
        <div class="card-body">
            <div class="assistant-messages mb-2" style="height: 265px; overflow-y: auto;">
                <div class="alert alert-info p-2 mb-2">¡Hola {{ request.user }}! Soy un asistente virtual que te puede ayudar a ubicar con que especialista dirigirte</div>
            </div>
            <!-- <div class="input-group">
                <input type="text" class="form-control" placeholder="Escribe tu respuesta...">
                <button class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </div> -->
        </div>
    </div>

    <button class="btn btn-primary rounded-circle" onclick="toggleAssistant()">
        <i class="bi bi-robot" style="font-size: 1.5rem;"></i>
    </button>
</div>
<script>
    function toggleAssistant() {
        const assistantCard = document.getElementById('assistantCard');
        assistantCard.style.display = assistantCard.style.display === 'none' ? 'block' : 'none';
    }
</script>
<script>
    const questions = [
        { text: "¿Qué tanto dolor de cabeza sientes?", labels: "(0 = Nada, 5 = Insoportable)" },
        { text: "¿Cómo calificarías tu fatiga en los últimos días?", labels: "(0 = Ninguna, 5 = Incapacitante)" },
        { text: "¿Cuánta dificultad tienes para respirar?", labels: "(0 = Normal, 5 = Asfixia)" },
        { text: "¿Qué tan alta es tu temperatura corporal?", labels: "(0 = Normal, 5 = Fiebre muy alta [>39°C])" },
        { text: "¿Qué tanto dolor articular/muscular experimentas?", labels: "(0 = Nada, 5 = Severo)" },
        { text: "¿Cómo es tu apetito?", labels: "(0 = Normal, 5 = Nulo)" },
        { text: "¿Has tenido tos persistente?", labels: "(0 = No, 5 = Constante con flemas)" },
        { text: "¿Sientes opresión en el pecho?", labels: "(0 = No, 5 = Intensa)" },
        { text: "¿Tienes mareos o desmayos?", labels: "(0 = No, 5 = Frecuentes)" },
        { text: "¿Has notado cambios en la piel?", labels: "(0 = No, 5 = Erupciones graves)" }
    ];

    let currentQuestionIndex = 0;
    let responses = [];

    const colors = ["#0000FF", "#4B75FF", "#9696FF", "#FFA07A", "#FF4500", "#FF0000"]; // Azul a rojo progresivo

    function scrollToBottom() {
        const chatContainer = document.querySelector(".assistant-messages");
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function askNextQuestion() {
        if (currentQuestionIndex < questions.length) {
            const question = questions[currentQuestionIndex];
            let buttonsHtml = "";
            for (let i = 0; i <= 5; i++) {
                buttonsHtml += `<button class='btn btn-sm response-btn' style='background-color: ${colors[i]}; color: white; margin: 2px;' onclick='handleResponse(${i})'>${i}</button>`;
            }
            document.querySelector(".assistant-messages").innerHTML += `<div class='alert alert-info p-2 mb-2'>${question.text}</div><div class='response-buttons'>${buttonsHtml}</div><div class='text-center mt-1' style='font-size: 0.9em;'>${question.labels}</div>`;
        } else {
            sendResponses();
        }
        scrollToBottom();
    }

    function sendResponses() {
        fetch('/reglasDifusas/', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ respuestas: responses })
        })
            .then(response => response.json())
            .then(data => {
                document.querySelector(".assistant-messages").innerHTML += `<div class='alert alert-success p-2 mb-2'>Cuestionario enviado con éxito.</div>`;
                scrollToBottom();
            })
            .catch(error => console.error('Error:', error));
    }

    function handleResponse(answer) {
        if (currentQuestionIndex < questions.length) {
            document.querySelector(".assistant-messages").innerHTML += `<div class='alert alert-secondary p-2 mb-2 text-end'>${answer}</div>`;
            responses.push({ pregunta: questions[currentQuestionIndex].text, respuesta: answer });
            currentQuestionIndex++;
            askNextQuestion();
        }
        scrollToBottom();
    }

    document.addEventListener("DOMContentLoaded", askNextQuestion);

</script>
<!-- <script src="/moduloPrincipal/static/bootstrap-5.3.3-dist/bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js"></script> -->
{% endblock %}