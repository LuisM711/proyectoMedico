<div class="assistant-container position-fixed bottom-0 end-0 mb-2 me-2 mb-md-3 me-md-3">
    <div class="card shadow-lg assistant-card" id="assistantCard">
        <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center assistant-header">
            <div class="d-flex align-items-center">
                <i class="bi bi-heart-pulse me-2 assistant-icon"></i>
                <span class="fw-bold assistant-title">Asistente nutricional</span>
            </div>
            <button type="button" class="btn-close btn-close-white" onclick="toggleAssistant()"></button>
        </div>
        <div class="card-body assistant-body">
            <div class="assistant-messages mb-3">
                <div class="alert alert-info p-2 p-md-3 mb-3 border-0 shadow-sm assistant-welcome">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-robot me-2 assistant-robot-icon"></i>
                        <div>
                            <strong>¡Hola {{ request.user.first_name }}!</strong><br>
                            <small>Soy tu asistente nutricional. Te haré algunas preguntas para evaluar tu perfil de riesgo nutricional y darte recomendaciones personalizadas.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress mb-2 assistant-progress">
                <div class="progress-bar bg-gradient" id="progressBar" role="progressbar" style="width: 0%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            </div>
            
            <!-- Input de comentarios eliminado - no se usa en el modelo -->
        </div>
    </div>

    <button class="btn btn-primary rounded-circle shadow-lg assistant-toggle-btn" onclick="toggleAssistant()">
        <i class="bi bi-heart-pulse assistant-toggle-icon"></i>
    </button>
</div>

<script>
    function toggleAssistant() {
        const assistantCard = document.getElementById('assistantCard');
        assistantCard.style.display = assistantCard.style.display === 'none' ? 'block' : 'none';
    }

    // === CUESTIONARIO NUTRICIONAL (10 Ítems) ===
    const questions = [
        {
            id: "alcohol",
            text: "En los últimos 12 meses, ¿con qué frecuencia bebiste bebidas alcohólicas (cerveza, vino o licor)?",
            type: "alcohol",
            options: [
                { value: 0, label: "Nunca", color: "#4CAF50", score: 0 },
                { value: 3, label: "1-3 veces al mes", color: "#8BC34A", score: 3 },
                { value: 7, label: "1-3 veces por semana", color: "#FFC107", score: 7 },
                { value: 10, label: "Casi todos los días", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "frutas",
            text: "¿Cuántas raciones de frutas frescas comes al día?",
            type: "fruit",
            options: [
                { value: 0, label: "3 raciones o más", color: "#4CAF50", score: 0 },
                { value: 3, label: "2 raciones", color: "#8BC34A", score: 3 },
                { value: 7, label: "1 ración", color: "#FFC107", score: 7 },
                { value: 10, label: "Menos de 1 ración", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "verduras",
            text: "¿Cuántas raciones de verduras comes al día?",
            type: "vegetables",
            options: [
                { value: 0, label: "3 raciones o más", color: "#4CAF50", score: 0 },
                { value: 3, label: "2 raciones", color: "#8BC34A", score: 3 },
                { value: 7, label: "1 ración", color: "#FFC107", score: 7 },
                { value: 10, label: "Menos de 1 ración", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "bebidas_azucaradas",
            text: "¿Cuántas veces por semana tomas refrescos o bebidas azucaradas?",
            type: "sugary_drinks",
            options: [
                { value: 0, label: "Nunca", color: "#4CAF50", score: 0 },
                { value: 3, label: "1-2 veces", color: "#8BC34A", score: 3 },
                { value: 7, label: "3-4 veces", color: "#FFC107", score: 7 },
                { value: 10, label: "5 o más veces", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "comida_rapida",
            text: "¿Cuántas veces por semana comes comida rápida o ultraprocesada?",
            type: "fast_food",
            options: [
                { value: 0, label: "Nunca", color: "#4CAF50", score: 0 },
                { value: 4, label: "1-2 veces", color: "#8BC34A", score: 4 },
                { value: 7, label: "3-4 veces", color: "#FFC107", score: 7 },
                { value: 10, label: "5 o más veces", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "agua",
            text: "¿Cuántos vasos o botellas de agua natural bebes al día?",
            type: "water",
            options: [
                { value: 0, label: "5 o más vasos", color: "#4CAF50", score: 0 },
                { value: 3, label: "3-4 vasos", color: "#8BC34A", score: 3 },
                { value: 7, label: "1-2 vasos", color: "#FFC107", score: 7 },
                { value: 10, label: "Menos de 1 vaso", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "granos_integrales",
            text: "¿Cuántas veces por semana consumes pan, cereal o arroz integral?",
            type: "whole_grains",
            options: [
                { value: 0, label: "5 o más veces", color: "#4CAF50", score: 0 },
                { value: 3, label: "3-4 veces", color: "#8BC34A", score: 3 },
                { value: 7, label: "1-2 veces", color: "#FFC107", score: 7 },
                { value: 10, label: "Nunca", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "sal_mesa",
            text: "¿Con qué frecuencia agregas sal a tus alimentos ya servidos?",
            type: "table_salt",
            options: [
                { value: 0, label: "Nunca", color: "#4CAF50", score: 0 },
                { value: 3, label: "Rara vez", color: "#8BC34A", score: 3 },
                { value: 7, label: "Algunas veces", color: "#FFC107", score: 7 },
                { value: 10, label: "Siempre", color: "#F44336", score: 10 }
            ]
        },
        {
            id: "suplementos",
            text: "¿Tomas suplementos vitamínicos o minerales habitualmente?",
            type: "supplements",
            options: [
                { value: 0, label: "Sí, diariamente o casi diario", color: "#4CAF50", score: 0 },
                { value: 2, label: "Ocasionalmente", color: "#FFC107", score: 2 },
                { value: 5, label: "No los tomo", color: "#F44336", score: 5 }
            ]
        },
        {
            id: "desayuno",
            text: "¿Cuántos días a la semana desayunas dentro de las 2 horas después de despertar?",
            type: "breakfast",
            options: [
                { value: 0, label: "5-7 días", color: "#4CAF50", score: 0 },
                { value: 4, label: "3-4 días", color: "#8BC34A", score: 4 },
                { value: 7, label: "1-2 días", color: "#FFC107", score: 7 },
                { value: 10, label: "Nunca", color: "#F44336", score: 10 }
            ]
        }
    ];

    const riskLookup = {
        "saludable": {
            title: "SALUDABLE",
            risk: "Alerta baja",
            summary: "Perfil nutricional equilibrado respaldado por hábitos protectores.",
            color: "#28a745"
        },
        "moderado": {
            title: "MODERADO",
            risk: "Alerta intermedia",
            summary: "Se identifican conductas que requieren ajustes para recuperar el equilibrio.",
            color: "#ffc107"
        },
        "alto": {
            title: "ALTO",
            risk: "Alerta alta",
            summary: "Múltiples conductas no saludables que demandan intervención prioritaria.",
            color: "#dc3545"
        }
    };

    let currentQuestionIndex = 0;
    let responses = [];

    function scrollToBottom() {
        const chatContainer = document.querySelector(".assistant-messages");
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateProgress() {
        const progress = (currentQuestionIndex / questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function askNextQuestion() {
        // Deshabilitar todos los botones de preguntas anteriores
        const allButtons = document.querySelectorAll('.response-options button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.onclick = null; // Remover el onclick para prevenir clics
        });
        
        if (currentQuestionIndex < questions.length) {
            const question = questions[currentQuestionIndex];
            let buttonsHtml = "";
            
            question.options.forEach((option, index) => {
                const color = option.color || "#6c757d";
                const label = option.label.replace(/"/g, '&quot;');
                const score = option.score !== undefined ? option.score : option.value;
                buttonsHtml += `
                    <button class='btn btn-sm mb-2 w-100 text-start' 
                            data-question-index='${currentQuestionIndex}'
                            style='background-color: ${color}; color: white; border: none; border-radius: 8px; padding: 10px 12px; font-size: 0.85rem;'
                            onclick='handleResponse("${question.id}", ${score}, "${label}", ${currentQuestionIndex})'>
                        ${option.label}
                    </button>`;
            });
            
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-light p-2 mb-2 border-0 shadow-sm'>
                    <div class='d-flex align-items-center mb-2'>
                        <i class='bi bi-question-circle me-2' style='color: #667eea; font-size: 1.1rem;'></i>
                        <strong style='font-size: 0.9rem;'>Pregunta ${currentQuestionIndex + 1} de ${questions.length}</strong>
                    </div>
                    <p class='mb-2 fw-semibold' style='font-size: 0.95rem;'>${question.text}</p>
                    <div class='response-options' data-question-index='${currentQuestionIndex}'>${buttonsHtml}</div>
                </div>`;
            
            updateProgress();
        } else {
            // Enviar directamente sin comentarios adicionales
            sendResponses();
        }
        scrollToBottom();
    }

    function handleResponse(questionId, score, label, questionIndex) {
        // Validar que la pregunta respondida sea la actual
        if (questionIndex !== currentQuestionIndex) {
            return; // Ignorar si no es la pregunta actual
        }
        
        if (currentQuestionIndex < questions.length) {
            const question = questions[currentQuestionIndex];
            
            // Deshabilitar todos los botones de esta pregunta
            const currentQuestionButtons = document.querySelectorAll(`.response-options[data-question-index="${questionIndex}"] button`);
            currentQuestionButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.onclick = null;
            });
            
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-secondary p-2 mb-2 text-end border-0 shadow-sm' style='background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);'>
                    <strong style='font-size: 0.9rem;'>${label}</strong>
                </div>`;
            
            responses.push({ 
                id: questionId,
                pregunta: question.text, 
                respuesta: score,
                label: label,
                type: question.type
            });
            
            currentQuestionIndex++;
            askNextQuestion();
        }
        scrollToBottom();
    }

    // === Mapeo mejorado a payload ===
    function mapToPayload(resps) {
        const scores = {};
        resps.forEach(resp => {
            scores[resp.id] = resp.respuesta;
        });
        return {
            scores: scores,
            respuestas: resps
        };
    }

    function sendResponses() {
        const payload = mapToPayload(responses);

        // Mostrar loading
        document.querySelector(".assistant-messages").innerHTML += `
            <div class='alert alert-info p-3 mb-3 border-0 shadow-sm text-center'>
                <div class='spinner-border spinner-border-sm me-2' role='status'></div>
                <strong>Analizando tu perfil nutricional...</strong>
            </div>`;
        scrollToBottom();

        fetch('/api/perfil-nutricional/', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            // Remover loading
            const loadingAlert = document.querySelector('.alert-info:last-child');
            if (loadingAlert) loadingAlert.remove();

            if (data && data.ok) {
                const riskInfo = riskLookup[data.risk_label] || riskLookup["moderado"];
                const riskColor = riskInfo.color;
                const riskIcon = data.risk_label === "alto"
                    ? "bi-exclamation-circle"
                    : data.risk_label === "moderado"
                        ? "bi-exclamation-triangle"
                        : "bi-check-circle";

                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert p-4 mb-3 border-0 shadow-sm text-center' style='border-radius: 14px; background: linear-gradient(135deg, ${riskColor}25 0%, ${riskColor}12 100%); border: 2px solid ${riskColor}40;'>
                        <span class='badge' style='background-color: ${riskColor}; color: white; font-size: 0.85rem; letter-spacing: 1px;'>${riskInfo.title}</span>
                        <h3 class='mt-3 mb-1 fw-bold' style='color: ${riskColor};'>Score: ${data.score.toFixed(1)} / 100</h3>
                        <p class='mb-1' style='font-size: 1rem;'>Nivel de alerta nutricional: <strong>${riskInfo.risk}</strong></p>
                        <small class='text-muted d-block mb-2'>Puntaje bruto: ${data.raw_score.toFixed(1)} / ${data.score_max}</small>
                        <p class='mb-0'>${riskInfo.summary}</p>
                    </div>`;

                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert p-3 mb-3 border-0 shadow-sm' style='background: linear-gradient(135deg, ${riskColor}15 0%, ${riskColor}25 100%); border-left: 4px solid ${riskColor}!important;'>
                        <div class='d-flex align-items-center mb-2'>
                            <i class='bi ${riskIcon} me-2' style='color: ${riskColor}; font-size: 1.5rem;'></i>
                            <strong style='color: ${riskColor};'>Resultado del Análisis</strong>
                        </div>
                        <p class='mb-0 fw-semibold'>${data.mensaje}</p>
                    </div>`;

                if (Array.isArray(data.recommendations)) {
                    const recsHtml = data.recommendations.map(r => `
                        <div class='d-flex align-items-start mb-2'>
                            <i class='bi bi-lightbulb me-2 mt-1' style='color: #667eea;'></i>
                            <span>${r}</span>
                        </div>
                    `).join("");
                    
                    document.querySelector(".assistant-messages").innerHTML += `
                        <div class='alert alert-light p-3 mb-3 border-0 shadow-sm'>
                            <div class='d-flex align-items-center mb-3'>
                                <i class='bi bi-list-ul me-2' style='color: #667eea; font-size: 1.2rem;'></i>
                                <strong>Recomendaciones personalizadas</strong>
                            </div>
                            ${recsHtml}
                        </div>`;
                }

                if (data.detalle) {
                    const detalleHtml = Object.entries(data.detalle).map(([clave, info]) => `
                        <div class='d-flex justify-content-between border-bottom py-1'>
                            <span class='text-muted'>${clave.replace(/_/g, " ")}</span>
                            <span class='fw-semibold'>${info.puntos.toFixed(1)} / ${info.maximo}</span>
                        </div>
                    `).join("");

                    document.querySelector(".assistant-messages").innerHTML += `
                        <div class='alert alert-light p-3 mb-3 border-0 shadow-sm'>
                            <div class='d-flex align-items-center mb-3'>
                                <i class='bi bi-clipboard-data me-2' style='color: #667eea; font-size: 1.2rem;'></i>
                                <strong>Detalle del puntaje (0-10 por pregunta)</strong>
                            </div>
                            ${detalleHtml}
                        </div>`;
                }

                const riskRows = Object.entries(riskLookup).map(([key, info]) => {
                    const active = key === data.risk_label;
                    return `
                        <tr style='background:${active ? info.color + "15" : "transparent"}'>
                            <td class='fw-bold' style='color:${info.color};'>${info.title}</td>
                            <td>${info.risk}</td>
                            <td>${info.summary}</td>
                        </tr>
                    `;
                }).join("");

                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert alert-light p-3 mb-3 border-0 shadow-sm'>
                        <div class='d-flex align-items-center mb-3'>
                            <i class='bi bi-pie-chart me-2' style='color: #667eea; font-size: 1.2rem;'></i>
                            <strong>Resumen de clasificación</strong>
                        </div>
                        <div class='table-responsive'>
                            <table class='table table-sm mb-0'>
                                <thead>
                                    <tr>
                                        <th>Etiqueta</th>
                                        <th>Nivel de alerta</th>
                                        <th>Interpretación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${riskRows}
                                </tbody>
                            </table>
                        </div>
                    </div>`;

                // Botón para reiniciar
                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='text-center mt-3'>
                        <button class='btn btn-outline-primary' onclick='restartAssessment()' style='border-radius: 25px; padding: 10px 30px;'>
                            <i class='bi bi-arrow-clockwise me-2'></i>Realizar nueva evaluación
                        </button>
                    </div>`;
            } else {
                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert alert-danger p-3 mb-3 border-0 shadow-sm'>
                        <i class='bi bi-exclamation-triangle me-2'></i>
                        <strong>Error</strong><br>
                        Ocurrió un problema procesando tu perfil. Por favor, intenta de nuevo.
                    </div>`;
            }
            scrollToBottom();
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-danger p-3 mb-3 border-0 shadow-sm'>
                    <i class='bi bi-wifi-off me-2'></i>
                    <strong>Error de Conexión</strong><br>
                    No se pudo conectar con el servidor. Verifica tu conexión e intenta de nuevo.
                </div>`;
            scrollToBottom();
        });
    }

    function restartAssessment() {
        currentQuestionIndex = 0;
        responses = [];
        
        document.querySelector(".assistant-messages").innerHTML = `
            <div class='alert alert-info p-3 mb-3 border-0 shadow-sm' style='background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);'>
                <div class='d-flex align-items-center'>
                    <i class='bi bi-robot me-2' style='font-size: 1.5rem; color: #1976d2;'></i>
                    <div>
                        <strong>¡Hola {{ request.user.first_name }}!</strong><br>
                        <small>Soy tu asistente nutricional. Te haré algunas preguntas para evaluar tu perfil de riesgo nutricional y darte recomendaciones personalizadas.</small>
                    </div>
                </div>
            </div>`;
        
        updateProgress();
        askNextQuestion();
    }

    document.addEventListener("DOMContentLoaded", function () {
        askNextQuestion();
    });
</script>

<style>
    .assistant-container {
        z-index: 1000;
    }

    /* Estilos base del card */
    .assistant-card {
        min-width: calc(100vw - 1rem);
        width: calc(100vw - 1rem);
        min-height: 60vh;
        height: 70vh;
        max-width: 500px;
        max-height: calc(100vh - 120px);
        display: block;
        resize: none;
        overflow: hidden;
        border-radius: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
    }

    @media (min-width: 576px) {
        .assistant-card {
            min-width: 90vw;
            width: 90vw;
        }
    }

    /* Desktop: permite resize y ajusta tamaño */
    @media (min-width: 768px) {
        .assistant-card {
            min-width: 450px;
            width: 450px;
            min-height: 400px;
            height: 500px;
            max-height: 600px;
            resize: both;
        }
    }

    .assistant-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15) !important;
    }

    /* Header */
    .assistant-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px 15px 0 0;
        padding: 0.75rem 1rem;
    }

    @media (max-width: 767px) {
        .assistant-header {
            padding: 0.5rem 0.75rem;
        }
    }

    .assistant-icon {
        font-size: 1rem;
    }

    @media (min-width: 768px) {
        .assistant-icon {
            font-size: 1.2rem;
        }
    }

    .assistant-title {
        font-size: 0.9rem;
    }

    @media (min-width: 768px) {
        .assistant-title {
            font-size: 1rem;
        }
    }

    /* Body */
    .assistant-body {
        height: calc(100% - 60px);
        background: #f8f9fa;
        padding: 0.75rem;
    }

    @media (max-width: 767px) {
        .assistant-body {
            height: calc(100% - 50px);
            padding: 0.5rem;
        }
    }

    /* Messages container */
    .assistant-messages {
        height: 85%;
        overflow-y: auto;
        border-radius: 10px;
    }

    .assistant-welcome {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }

    .assistant-robot-icon {
        font-size: 1.2rem;
        color: #1976d2;
    }

    @media (min-width: 768px) {
        .assistant-robot-icon {
            font-size: 1.5rem;
        }
    }

    /* Progress bar */
    .assistant-progress {
        height: 4px;
        border-radius: 2px;
    }

    /* Toggle button */
    .assistant-toggle-btn {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0;
    }

    @media (min-width: 768px) {
        .assistant-toggle-btn {
            width: 60px;
            height: 60px;
        }
    }

    .assistant-toggle-icon {
        font-size: 1.5rem;
    }

    @media (min-width: 768px) {
        .assistant-toggle-icon {
            font-size: 1.8rem;
        }
    }

    .response-options .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
    }

    /* Ajustes de botones en móvil */
    @media (max-width: 767px) {
        .response-options .btn {
            font-size: 0.8rem !important;
            padding: 8px 10px !important;
        }
        
        /* Ajustes de texto en alertas */
        .assistant-messages .alert {
            font-size: 0.85rem;
        }
        
        .assistant-messages .alert strong {
            font-size: 0.85rem !important;
        }
        
        .assistant-messages .alert p {
            font-size: 0.9rem !important;
        }
        
        .assistant-messages .alert small {
            font-size: 0.75rem;
        }
        
        /* Iconos más pequeños en móvil */
        .assistant-messages .bi {
            font-size: 1rem !important;
        }
    }

    /* Estilos de scrollbar para máxima compatibilidad */
    .assistant-messages {
        /* Firefox */
        scrollbar-width: thin;
        scrollbar-color: #c1c1c1 #f1f1f1;
        
        /* Edge Legacy (antes de Chromium) */
        -ms-overflow-style: -ms-autohiding-scrollbar;
    }

    /* Chrome, Safari, Edge Chromium, Opera (WebKit/Blink) */
    .assistant-messages::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }

    .assistant-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
        -webkit-box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .assistant-messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
        -webkit-box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.1);
    }

    .assistant-messages::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .assistant-messages::-webkit-scrollbar-thumb:active {
        background: #909090;
    }

    /* Fallback para navegadores que no soportan personalización */
    @supports not (scrollbar-width: thin) and not selector(::-webkit-scrollbar) {
        .assistant-messages {
            overflow-y: auto;
            /* Usa la scrollbar nativa del navegador */
        }
    }

    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
</style>