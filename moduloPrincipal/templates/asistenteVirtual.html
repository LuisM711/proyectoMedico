<div class="assistant-container position-fixed bottom-0 end-0 mb-3 me-3">
    <div class="card shadow-lg assistant-card" id="assistantCard"
        style="min-width: 450px; width: 450px; min-height: 400px; height: 500px; display: block; max-width: 500px; max-height: 600px; resize: both; overflow: hidden; border-radius: 15px;">
        <div class="card-header bg-gradient text-white d-flex justify-content-between align-items-center" 
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px 15px 0 0;">
            <div class="d-flex align-items-center">
                <i class="bi bi-heart-pulse me-2" style="font-size: 1.2rem;"></i>
                <span class="fw-bold">Asistente nutricional</span>
            </div>
            <button type="button" class="btn-close btn-close-white" onclick="toggleAssistant()"></button>
        </div>
        <div class="card-body p-3" style="height: calc(100% - 60px); background: #f8f9fa;">
            <div class="assistant-messages mb-3" style="height: 85%; overflow-y: auto; border-radius: 10px;">
                <div class="alert alert-info p-3 mb-3 border-0 shadow-sm" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-robot me-2" style="font-size: 1.5rem; color: #1976d2;"></i>
                        <div>
                            <strong>¡Hola {{ request.user.first_name }}!</strong><br>
                            <small>Soy tu asistente nutricional. Te haré algunas preguntas para evaluar tu perfil de riesgo cardiometabólico y darte recomendaciones personalizadas.</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress mb-2" style="height: 4px; border-radius: 2px;">
                <div class="progress-bar bg-gradient" id="progressBar" role="progressbar" style="width: 0%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            </div>
            
            <!-- Input de comentarios eliminado - no se usa en el modelo -->
        </div>
    </div>

    <button class="btn btn-primary rounded-circle shadow-lg" onclick="toggleAssistant()" 
            style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
        <i class="bi bi-heart-pulse" style="font-size: 1.8rem;"></i>
    </button>
</div>

<script>
    function toggleAssistant() {
        const assistantCard = document.getElementById('assistantCard');
        assistantCard.style.display = assistantCard.style.display === 'none' ? 'block' : 'none';
    }

    // === PREGUNTAS MEJORADAS ===
    const questions = [
        {
            text: "¿Cuál es tu edad?",
            type: "age",
            options: [
                { value: 18, label: "18-25 años" },
                { value: 30, label: "26-35 años" },
                { value: 40, label: "36-45 años" },
                { value: 50, label: "46-55 años" },
                { value: 60, label: "56-65 años" },
                { value: 70, label: "65+ años" }
            ]
        },
        {
            text: "¿Cuál es tu sexo?",
            type: "gender",
            options: [
                { value: "M", label: "Masculino" },
                { value: "F", label: "Femenino" }
            ]
        },
        {
            text: "¿En qué rango está tu IMC (Índice de Masa Corporal)?",
            type: "bmi",
            options: [
                { value: 0, label: "Bajo peso (<18.5)", color: "#4CAF50" },
                { value: 1, label: "Normal (18.5-24.9)", color: "#8BC34A" },
                { value: 2, label: "Sobrepeso (25-29.9)", color: "#FFC107" },
                { value: 3, label: "Obesidad I (30-34.9)", color: "#FF9800" },
                { value: 4, label: "Obesidad II (35-39.9)", color: "#FF5722" },
                { value: 5, label: "Obesidad III (≥40)", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuál es tu presión arterial sistólica?",
            type: "sbp",
            options: [
                { value: 0, label: "Óptima (<120)", color: "#4CAF50" },
                { value: 1, label: "Normal (120-129)", color: "#8BC34A" },
                { value: 2, label: "Normal alta (130-139)", color: "#FFC107" },
                { value: 3, label: "Hipertensión I (140-159)", color: "#FF9800" },
                { value: 4, label: "Hipertensión II (160-179)", color: "#FF5722" },
                { value: 5, label: "Crisis (>180)", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuál es tu presión arterial diastólica?",
            type: "dbp",
            options: [
                { value: 0, label: "Óptima (<80)", color: "#4CAF50" },
                { value: 1, label: "Normal (80-84)", color: "#8BC34A" },
                { value: 2, label: "Normal alta (85-89)", color: "#FFC107" },
                { value: 3, label: "Hipertensión I (90-99)", color: "#FF9800" },
                { value: 4, label: "Hipertensión II (100-109)", color: "#FF5722" },
                { value: 5, label: "Crisis (>110)", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuál se acerca más a tu ingesta calórica diaria?",
            type: "calories",
            options: [
                { value: 0, label: "Muy baja (1200-1500 kcal)", color: "#4CAF50" },
                { value: 1, label: "Baja (1500-1800 kcal)", color: "#8BC34A" },
                { value: 2, label: "Moderada (1800-2200 kcal)", color: "#FFC107" },
                { value: 3, label: "Alta (2200-2600 kcal)", color: "#FF9800" },
                { value: 4, label: "Muy alta (2600-3000 kcal)", color: "#FF5722" },
                { value: 5, label: "Excesiva (>3000 kcal)", color: "#F44336" }
            ]
        },
        {
            text: "¿Qué porcentaje de tus calorías proviene de proteínas?",
            type: "protein",
            options: [
                { value: 0, label: "Muy bajo (5-10%)", color: "#F44336" },
                { value: 1, label: "Bajo (10-15%)", color: "#FF5722" },
                { value: 2, label: "Adecuado (15-20%)", color: "#FFC107" },
                { value: 3, label: "Bueno (20-25%)", color: "#8BC34A" },
                { value: 4, label: "Alto (25-30%)", color: "#4CAF50" },
                { value: 5, label: "Muy alto (>30%)", color: "#2196F3" }
            ]
        },
        {
            text: "¿Qué porcentaje de tus calorías proviene de carbohidratos?",
            type: "carbs",
            options: [
                { value: 0, label: "Muy bajo (<30%)", color: "#F44336" },
                { value: 1, label: "Bajo (30-40%)", color: "#FF5722" },
                { value: 2, label: "Adecuado (40-50%)", color: "#FFC107" },
                { value: 3, label: "Moderado (50-60%)", color: "#8BC34A" },
                { value: 4, label: "Alto (60-70%)", color: "#FF9800" },
                { value: 5, label: "Muy alto (>70%)", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuántos gramos de azúcares añadidos consumes al día?",
            type: "sugar",
            options: [
                { value: 0, label: "Muy poco (<10g)", color: "#4CAF50" },
                { value: 1, label: "Poco (10-25g)", color: "#8BC34A" },
                { value: 2, label: "Moderado (25-50g)", color: "#FFC107" },
                { value: 3, label: "Alto (50-75g)", color: "#FF9800" },
                { value: 4, label: "Muy alto (75-100g)", color: "#FF5722" },
                { value: 5, label: "Excesivo (>100g)", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuántos gramos de fibra consumes al día?",
            type: "fiber",
            options: [
                { value: 0, label: "Muy poco (<10g)", color: "#F44336" },
                { value: 1, label: "Poco (10-15g)", color: "#FF5722" },
                { value: 2, label: "Moderado (15-20g)", color: "#FFC107" },
                { value: 3, label: "Bueno (20-25g)", color: "#8BC34A" },
                { value: 4, label: "Alto (25-30g)", color: "#4CAF50" },
                { value: 5, label: "Excelente (>30g)", color: "#2196F3" }
            ]
        },
        {
            text: "¿Cuántos miligramos de sodio consumes al día?",
            type: "sodium",
            options: [
                { value: 0, label: "Muy bajo (<1500mg)", color: "#4CAF50" },
                { value: 1, label: "Bajo (1500-2000mg)", color: "#8BC34A" },
                { value: 2, label: "Adecuado (2000-2300mg)", color: "#FFC107" },
                { value: 3, label: "Alto (2300-3000mg)", color: "#FF9800" },
                { value: 4, label: "Muy alto (3000-4000mg)", color: "#FF5722" },
                { value: 5, label: "Excesivo (>4000mg)", color: "#F44336" }
            ]
        },
        {
            text: "¿Fumas actualmente?",
            type: "smoking",
            options: [
                { value: 0, label: "Nunca he fumado", color: "#4CAF50" },
                { value: 1, label: "Fumé pero dejé hace años", color: "#8BC34A" },
                { value: 2, label: "Fumé pero dejé recientemente", color: "#FFC107" },
                { value: 3, label: "Fumo ocasionalmente", color: "#FF9800" },
                { value: 4, label: "Fumo regularmente", color: "#FF5722" },
                { value: 5, label: "Fumo mucho", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuántos días a la semana consumes alcohol?",
            type: "alcohol",
            options: [
                { value: 0, label: "Nunca", color: "#4CAF50" },
                { value: 1, label: "1 día", color: "#8BC34A" },
                { value: 2, label: "2 días", color: "#FFC107" },
                { value: 3, label: "3 días", color: "#FF9800" },
                { value: 4, label: "4-5 días", color: "#FF5722" },
                { value: 5, label: "6-7 días", color: "#F44336" }
            ]
        },
        {
            text: "¿Cuántos días a la semana haces actividad física moderada o intensa?",
            type: "exercise",
            options: [
                { value: 0, label: "Nunca", color: "#F44336" },
                { value: 1, label: "1 día", color: "#FF5722" },
                { value: 2, label: "2 días", color: "#FF9800" },
                { value: 3, label: "3 días", color: "#FFC107" },
                { value: 4, label: "4-5 días", color: "#8BC34A" },
                { value: 5, label: "6-7 días", color: "#4CAF50" }
            ]
        }
    ];

    let currentQuestionIndex = 0;
    let responses = [];

    function scrollToBottom() {
        const chatContainer = document.querySelector(".assistant-messages");
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateProgress() {
        const progress = (currentQuestionIndex / questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function askNextQuestion() {
        if (currentQuestionIndex < questions.length) {
            const question = questions[currentQuestionIndex];
            let buttonsHtml = "";
            
            question.options.forEach((option, index) => {
                const color = option.color || "#6c757d";
                const value = typeof option.value === 'string' ? `"${option.value}"` : option.value;
                const label = option.label.replace(/"/g, '&quot;');
                buttonsHtml += `
                    <button class='btn btn-sm mb-2 w-100 text-start' 
                            style='background-color: ${color}; color: white; border: none; border-radius: 8px; padding: 10px 12px; font-size: 0.85rem;'
                            onclick='handleResponse(${value}, "${label}")'>
                        ${option.label}
                    </button>`;
            });
            
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-light p-2 mb-2 border-0 shadow-sm'>
                    <div class='d-flex align-items-center mb-2'>
                        <i class='bi bi-question-circle me-2' style='color: #667eea; font-size: 1.1rem;'></i>
                        <strong style='font-size: 0.9rem;'>Pregunta ${currentQuestionIndex + 1} de ${questions.length}</strong>
                    </div>
                    <p class='mb-2 fw-semibold' style='font-size: 0.95rem;'>${question.text}</p>
                    <div class='response-options'>${buttonsHtml}</div>
                </div>`;
            
            updateProgress();
        } else {
            // Enviar directamente sin comentarios adicionales
            sendResponses();
        }
        scrollToBottom();
    }

    function handleResponse(value, label) {
        if (currentQuestionIndex < questions.length) {
            const question = questions[currentQuestionIndex];
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-secondary p-2 mb-2 text-end border-0 shadow-sm' style='background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);'>
                    <strong style='font-size: 0.9rem;'>${label}</strong>
                </div>`;
            
            responses.push({ 
                pregunta: question.text, 
                respuesta: value,
                label: label,
                type: question.type
            });
            
            currentQuestionIndex++;
            askNextQuestion();
        }
        scrollToBottom();
    }

    // === Mapeo mejorado a payload ===
    function mapToPayload(resps) {
        const getResponse = (type) => {
            const resp = resps.find(r => r.type === type);
            return resp ? resp.respuesta : 0;
        };

        // Mapeo de valores específicos
        const ageMap = [18, 30, 40, 50, 60, 70];
        const bmiMap = [17.5, 22.0, 27.0, 32.0, 37.0, 42.0];
        const sbpMap = [110, 125, 135, 150, 170, 190];
        const dbpMap = [70, 82, 87, 95, 105, 115];
        const kcalMap = [1350, 1650, 2000, 2400, 2800, 3200];
        const protMap = [7.5, 12.5, 17.5, 22.5, 27.5, 32.5];
        const carbMap = [25, 35, 45, 55, 65, 75];
        const sugarMap = [5, 17.5, 37.5, 62.5, 87.5, 120];
        const fiberMap = [8, 12.5, 17.5, 22.5, 27.5, 35];
        const sodiumMap = [1200, 1750, 2150, 2650, 3500, 4500];
        const alcoholMap = [0, 1, 2, 3, 4.5, 6.5];
        const exerciseMap = [0, 1, 2, 3, 4.5, 6.5];

        const age = ageMap[getResponse('age')];
        const sex = getResponse('gender') === 0 ? 'M' : 'F';
        const bmi = bmiMap[getResponse('bmi')];
        const sbp = sbpMap[getResponse('sbp')];
        const dbp = dbpMap[getResponse('dbp')];
        const kcal = kcalMap[getResponse('calories')];
        const protein = protMap[getResponse('protein')];
        const carbs = carbMap[getResponse('carbs')];
        const sugar = sugarMap[getResponse('sugar')];
        const fiber = fiberMap[getResponse('fiber')];
        const sodium = sodiumMap[getResponse('sodium')];
        const smoking = getResponse('smoking') >= 3 ? 1 : 0;
        const alcohol = alcoholMap[getResponse('alcohol')];
        const exercise = exerciseMap[getResponse('exercise')];

        // Calcular % grasa
        let fat = 100 - (protein + carbs);
        if (fat < 0) fat = 0;

        return {
            "edad": age,
            "sexo": sex,
            "BMI": bmi,
            "presion_sistolica": sbp,
            "presion_diastolica": dbp,
            "DR1TKCAL": kcal,
            "pct_protein": protein,
            "pct_carb": carbs,
            "pct_fat": fat,
            "DR1TSUGR": sugar,
            "DR1TFIBE": fiber,
            "DR1TSODI": sodium,
            "is_smoker": smoking,
            "alcohol_days": alcohol,
            "phys_act_days": exercise
        };
    }

    function sendResponses() {
        const payload = mapToPayload(responses);
        // Los comentarios no se usan en el modelo, se eliminaron para simplificar

        // Mostrar loading
        document.querySelector(".assistant-messages").innerHTML += `
            <div class='alert alert-info p-3 mb-3 border-0 shadow-sm text-center'>
                <div class='spinner-border spinner-border-sm me-2' role='status'></div>
                <strong>Analizando tu perfil nutricional...</strong>
            </div>`;
        scrollToBottom();

        fetch('/api/perfil-nutricional/', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            // Remover loading
            const loadingAlert = document.querySelector('.alert-info:last-child');
            if (loadingAlert) loadingAlert.remove();

            if (data && data.mensaje) {
                // Determinar color según riesgo
                let riskColor = "#28a745"; // Verde para bajo
                let riskIcon = "bi-check-circle";
                if (data.risk_label === "medium") {
                    riskColor = "#ffc107";
                    riskIcon = "bi-exclamation-triangle";
                } else if (data.risk_label === "high") {
                    riskColor = "#dc3545";
                    riskIcon = "bi-exclamation-circle";
                }

                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert p-3 mb-3 border-0 shadow-sm' style='background: linear-gradient(135deg, ${riskColor}15 0%, ${riskColor}25 100%); border-left: 4px solid ${riskColor}!important;'>
                        <div class='d-flex align-items-center mb-2'>
                            <i class='bi ${riskIcon} me-2' style='color: ${riskColor}; font-size: 1.5rem;'></i>
                            <strong style='color: ${riskColor};'>Resultado del Análisis</strong>
                        </div>
                        <p class='mb-0 fw-semibold'>${data.mensaje}</p>
                    </div>`;

                if (Array.isArray(data.recommendations)) {
                    const recsHtml = data.recommendations.map(r => `
                        <div class='d-flex align-items-start mb-2'>
                            <i class='bi bi-lightbulb me-2 mt-1' style='color: #667eea;'></i>
                            <span>${r}</span>
                        </div>
                    `).join("");
                    
                    document.querySelector(".assistant-messages").innerHTML += `
                        <div class='alert alert-light p-3 mb-3 border-0 shadow-sm'>
                            <div class='d-flex align-items-center mb-3'>
                                <i class='bi bi-list-ul me-2' style='color: #667eea; font-size: 1.2rem;'></i>
                                <strong>Recomendaciones Personalizadas</strong>
                            </div>
                            ${recsHtml}
                        </div>`;
                }

                if (data.probabilities) {
                    const probs = data.probabilities;
                    const pct = k => (probs[k] != null ? (probs[k] * 100).toFixed(1) + "%" : "—");
                    
                    document.querySelector(".assistant-messages").innerHTML += `
                        <div class='alert alert-light p-3 mb-3 border-0 shadow-sm'>
                            <div class='d-flex align-items-center mb-3'>
                                <i class='bi bi-pie-chart me-2' style='color: #667eea; font-size: 1.2rem;'></i>
                                <strong>Probabilidades de Riesgo</strong>
                            </div>
                            <div class='row text-center'>
                                <div class='col-4'>
                                    <div class='p-2 rounded' style='background: #28a74520;'>
                                        <div class='fw-bold text-success'>${pct("low")}</div>
                                        <small class='text-muted'>Bajo</small>
                                    </div>
                                </div>
                                <div class='col-4'>
                                    <div class='p-2 rounded' style='background: #ffc10720;'>
                                        <div class='fw-bold text-warning'>${pct("medium")}</div>
                                        <small class='text-muted'>Medio</small>
                                    </div>
                                </div>
                                <div class='col-4'>
                                    <div class='p-2 rounded' style='background: #dc354520;'>
                                        <div class='fw-bold text-danger'>${pct("high")}</div>
                                        <small class='text-muted'>Alto</small>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                // Botón para reiniciar
                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='text-center mt-3'>
                        <button class='btn btn-outline-primary' onclick='restartAssessment()' style='border-radius: 25px; padding: 10px 30px;'>
                            <i class='bi bi-arrow-clockwise me-2'></i>Realizar Nueva Evaluación
                        </button>
                    </div>`;
            } else {
                document.querySelector(".assistant-messages").innerHTML += `
                    <div class='alert alert-danger p-3 mb-3 border-0 shadow-sm'>
                        <i class='bi bi-exclamation-triangle me-2'></i>
                        <strong>Error</strong><br>
                        Ocurrió un problema procesando tu perfil. Por favor, intenta de nuevo.
                    </div>`;
            }
            scrollToBottom();
        })
        .catch(error => {
            console.error('Error:', error);
            document.querySelector(".assistant-messages").innerHTML += `
                <div class='alert alert-danger p-3 mb-3 border-0 shadow-sm'>
                    <i class='bi bi-wifi-off me-2'></i>
                    <strong>Error de Conexión</strong><br>
                    No se pudo conectar con el servidor. Verifica tu conexión e intenta de nuevo.
                </div>`;
            scrollToBottom();
        });
    }

    function restartAssessment() {
        currentQuestionIndex = 0;
        responses = [];
        
        document.querySelector(".assistant-messages").innerHTML = `
            <div class='alert alert-info p-3 mb-3 border-0 shadow-sm' style='background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);'>
                <div class='d-flex align-items-center'>
                    <i class='bi bi-robot me-2' style='font-size: 1.5rem; color: #1976d2;'></i>
                    <div>
                        <strong>¡Hola {{ request.user.first_name }}!</strong><br>
                        <small>Soy tu asistente nutricional. Te haré algunas preguntas para evaluar tu perfil de riesgo cardiometabólico y darte recomendaciones personalizadas.</small>
                    </div>
                </div>
            </div>`;
        
        updateProgress();
        askNextQuestion();
    }

    document.addEventListener("DOMContentLoaded", function () {
        askNextQuestion();
    });
</script>

<style>
    .assistant-container {
        z-index: 1000;
    }

    .assistant-card {
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
    }

    .assistant-card:hover {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15) !important;
    }

    .response-options .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
    }

    .assistant-messages::-webkit-scrollbar {
        width: 6px;
    }

    .assistant-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .assistant-messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .assistant-messages::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
</style>